#!/usr/bin/env python

###
# Gimb - Github Markdown Blogger
###

import sys, os, json, argparse
import misaka as m
from mako.template import Template
from mako.lookup import TemplateLookup

version_number = "0.1"
config_file = 'gymb.json'

mylookup = TemplateLookup(directories=['.'])
gimp_template = """<%inherit file="base.html"/><%block name="content">${cnt}</%block>"""

## Config actions
#

def read_config():
    return json.loads(open(config_file).read())

def save_config(config):
    open(config_file,'w').write(json.dumps(config))

## Blog actions
#

def add_blog(config, args):
    if os.path.exists(args.path):
        sys.exit("ERROR: %s already exists." % args.path)
    path = args.path.split('/')
    if len(path) > 2:
        sys.exit("ERROR: Too long path. Gymb only support 1 level deep blogs.")
    blog = path[0]
    if blog not in config['blogs']:
        os.makedirs(blog)
        config['blogs'].append(blog)
        config[blog] = {}
        save_config(config)
        print "Added blog %s" % blog
    if len(path) == 2:
        post = path[1]
        if not post.endswith('.md'):
            sys.exit("ERROR: For now posts need's to use the .md (markdown) extension.")
        open(args.path, 'w').close()
        print "Added %s to %s" % (post,blog)

def del_blog(config, args):
    print "removing blog"

def blog(config):
    if len(sys.argv) < 2:
        sys.exit("Usage: <add> or <blogname>")
    arg = sys.argv[2]
    if arg != 'add' and arg not in config['blogs']:
        sys.exit("Usage: <add> or <blogname>")
    if arg == 'add':
        name = len(sys.argv) > 2 and sys.argv[3] or ""
        if name == "":
            sys.exit("Usage: <add> <blogname>")
        if not os.path.exists(name):
            os.makedirs(name)
            config['blogs'].append(name)
            config[name] = {}
    else:
        blog = config[arg]
        arg2 = len(sys.argv) > 2 and sys.argv[3] or ""
        if arg2 not in blog_action_map.keys():
            sys.exit("Usage: <blogname> <add>")
        blog_action_map[arg2](config)

## Build actions
#

def build(config):
    makofiles = []
    mdfiles = []
    for (path, dirs, files) in os.walk('.'):
        for file in files:
            if file.endswith('.mako'):
                makofiles.append('%s/%s' % (path, file))
            if file.endswith('.md'):
                mdfiles.append('%s/%s' % (path, file))
    for mdf in mdfiles:
        content  = m.html(open(mdf).read())
        makofile = mdf.replace('.md','.mako')
        if (makofile in makofiles):
            template = open(makofile).read()
        else:
            template = gimp_template
        tmpl = Template(template, lookup=mylookup)
        html = tmpl.render(cnt=content)
        open(mdf.replace('.md','.html'),'w').write(html)
    for mf in makofiles:
        mdfile = mf.replace('.mako','.md')
        if (mdfile not in mdfiles):
            tmpl = Template(filename=mf, lookup=mylookup)
            html = tmpl.render()
            open(mf.replace('.mako','.html'),'w').write(html)

blog_action_map = {
    'add' : add_blog,
    'del' : del_blog
}

parser = argparse.ArgumentParser(description='Gymb ~ The Github Python Markdown Blogger.')
subparsers = parser.add_subparsers()
parser_build = subparsers.add_parser('build', help='Generate html from .md and .mako files.')
parser_build.set_defaults(intent='build')
parser_blog = subparsers.add_parser('blog', help='Add, del or interact with a blog')
parser_blog.set_defaults(intent='blog')
parser_blog.add_argument('action', choices=['add','del'], help='Add or del a blog or a post')
parser_blog.add_argument('path', type=str, help='Path to blog or post')
parser.add_argument('--version', action='version', version='%(prog)s '+version_number)
args = parser.parse_args()

if __name__ == "__main__":
    args = parser.parse_args()
    config = read_config()
    if args.intent == 'build':
        build(config)
    if args.intent == 'blog':
        blog_action_map[args.action](config, args)
    save_config(config)
